#! /bin/bash
#
# This will run the GN2 server (with default settings if none supplied). Pass in
# your own settings file, e.g.
#
#   ./bin/genenetwork2 ~/my_settings.py
#
# To run a maintenance script with settings (instead of the webserver) add that with
# a -c switch, e.g.
#
#   ./bin/genenetwork2 ~/my_settings.py -c ./wqflask/maintenance/gen_select_dataset.py
#
# Environment settings can be used to preconfigure as well as a
# settings.py file.

SCRIPT=$(readlink -f "$0")
GN2_BASE_PATH=$(dirname $(dirname "$SCRIPT"))

GN2_GUIX_PATH=$GN2_BASE_PATH/lib/python2.7/site-packages/genenetwork2-2.0-py2.7.egg
if [ -d $GN2_GUIX_PATH ]; then
  echo GN2 is running from GUIX
  GN2_BASE_PATH=$GN2_GUIX_PATH
fi
echo $GN2_BASE_PATH

# Handle settings parameter
settings=$1
if [ -z $settings ]; then
    # get default
    settings=$GN2_BASE_PATH/etc/default_settings.py
else
    shift
fi
if [ ! -e $settings ]; then
    echo "ERROR: can not locate settings file - pass it in the command line"
    exit 1
fi
export WQFLASK_SETTINGS=$settings

# We may change this one:
export PYTHONPATH=$GN2_BASE_PATH/wqflask:$PYTHONPATH

# TEMPDIR defaults to /tmp if nothing else
if [ -z $TEMPDIR ]; then
    TEMPDIR="/tmp"
fi

# Now handle command parameter -c
if [ $1 = '-c' ] ; then
    cd $GN2_BASE_PATH/wqflask
    cmd=${2#wqflask/}
    echo PYTHONPATH=$PYTHONPATH
    echo RUNNING COMMAND $cmd
    /usr/bin/env python $cmd
    exit 0
fi

echo "Starting the redis server:"
echo -n "dir $TEMPDIR
dbfilename gn2.rdb
" | redis-server - &

# Start the flask server running GN2
cd $GN2_BASE_PATH/wqflask
echo "Starting with $settings"
/usr/bin/env python runserver.py
